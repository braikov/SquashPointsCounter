@using Microsoft.AspNetCore.Mvc.Rendering
@using Squash.DataAccess.Entities
@model TournamentEventsViewModel

@{
    ViewData["Title"] = $"{Model.TournamentName} - Events";

    var ageOptions = Enum.GetValues<EventAge>()
        .Select(v => new SelectListItem
        {
            Value = v.ToString(),
            Text = FormatAgePreset(v),
            Selected = Model.EventForm.AgePreset.HasValue && Model.EventForm.AgePreset.Value == v
        })
        .ToList();
}

<partial name="_TournamentTabs" model='new TournamentHeaderViewModel { Id = Model.TournamentId, Name = Model.TournamentName, ActiveTab = "Events", IsPublished = Model.IsPublished }' />

<div class="row g-4">
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header">
                <strong>Events</strong>
            </div>
            <div class="card-body">
                @if (Model.Events.Count == 0)
                {
                    <p class="text-muted mb-0">No events yet.</p>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Match type</th>
                                    <th>Age</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var evt in Model.Events)
                            {
                                <tr>
                                    <td>@evt.Name</td>
                                    <td>@evt.MatchType</td>
                                    <td>@FormatAgeValue(evt.Direction, evt.Age)</td>
                                    <td class="text-end">
                                        <a class="btn btn-sm btn-outline-primary"
                                           asp-area="Administration"
                                           asp-controller="Tournaments"
                                           asp-action="Draws"
                                           asp-route-id="@Model.TournamentId"
                                           asp-route-eventId="@evt.Id">Draws</a>
                                        <a class="btn btn-sm btn-outline-secondary"
                                           asp-area="Administration"
                                           asp-controller="Tournaments"
                                           asp-action="Events"
                                           asp-route-id="@Model.TournamentId"
                                           asp-route-eventId="@evt.Id">Edit</a>
                                        <form class="d-inline" asp-area="Administration" asp-controller="Tournaments" asp-action="DeleteEvent" method="post">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@Model.TournamentId" />
                                            <input type="hidden" name="eventId" value="@evt.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card">
            <div class="card-header">
                <strong>@(Model.EventForm.Id.HasValue ? "Edit Event" : "Add Event")</strong>
            </div>
            <div class="card-body">
                <form asp-area="Administration" asp-controller="Tournaments" asp-action="SaveEvent" method="post" novalidate>
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="EventForm.TournamentId" />
                    <input type="hidden" asp-for="EventForm.Id" />

                    <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-3"></div>

                    <div class="mb-3">
                        <label asp-for="EventForm.Name" class="form-label"></label>
                        <input asp-for="EventForm.Name" class="form-control" />
                        <span asp-validation-for="EventForm.Name" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="EventForm.MatchType" class="form-label"></label>
                        <select asp-for="EventForm.MatchType"
                                asp-items="Html.GetEnumSelectList<MatchType>()"
                                class="form-select"></select>
                        <span asp-validation-for="EventForm.MatchType" class="text-danger small"></span>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Age</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="radio"
                                       name="EventForm.UsePresetAge"
                                       id="AgePresetOption"
                                       value="true"
                                       @(Model.EventForm.UsePresetAge ? "checked" : null) />
                                <label class="form-check-label" for="AgePresetOption">Preset</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="radio"
                                       name="EventForm.UsePresetAge"
                                       id="AgeCustomOption"
                                       value="false"
                                       @(!Model.EventForm.UsePresetAge ? "checked" : null) />
                                <label class="form-check-label" for="AgeCustomOption">Custom</label>
                            </div>
                        </div>
                    </div>

                    <div id="AgePresetGroup" class="mb-3">
                        <select asp-for="EventForm.AgePreset"
                                asp-items="ageOptions"
                                class="form-select"></select>
                        <span asp-validation-for="EventForm.AgePreset" class="text-danger small"></span>
                    </div>

                    <div id="AgeCustomGroup" class="mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <input asp-for="EventForm.CustomAge" class="form-control" type="number" min="1" />
                                <span asp-validation-for="EventForm.CustomAge" class="text-danger small"></span>
                            </div>
                            <div class="col-6">
                                <select asp-for="EventForm.Direction"
                                        asp-items="Html.GetEnumSelectList<Direction>()"
                                        class="form-select">
                                    <option value="">-- Direction --</option>
                                </select>
                                <span asp-validation-for="EventForm.Direction" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <a class="btn btn-secondary"
                           asp-area="Administration"
                           asp-controller="Tournaments"
                           asp-action="Events"
                           asp-route-id="@Model.TournamentId">Reset</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            var presetOption = document.getElementById('AgePresetOption');
            var customOption = document.getElementById('AgeCustomOption');
            var presetGroup = document.getElementById('AgePresetGroup');
            var customGroup = document.getElementById('AgeCustomGroup');

            if (!presetOption || !customOption || !presetGroup || !customGroup) {
                return;
            }

            function toggleAgeGroups() {
                var usePreset = presetOption.checked;
                presetGroup.classList.toggle('opacity-50', !usePreset);
                customGroup.classList.toggle('opacity-50', usePreset);

                presetGroup.querySelectorAll('select').forEach(function (el) {
                    el.disabled = !usePreset;
                });
                customGroup.querySelectorAll('input, select').forEach(function (el) {
                    el.disabled = usePreset;
                });
            }

            presetOption.addEventListener('change', toggleAgeGroups);
            customOption.addEventListener('change', toggleAgeGroups);
            toggleAgeGroups();
        })();
    </script>
}

@functions {
    private static string FormatAgeValue(Direction direction, int age)
    {
        var label = direction == Direction.Above ? "Above" : "Under";
        return $"{label} {age}";
    }

    private static string FormatAgePreset(EventAge age)
    {
        var name = age.ToString();
        if (name.StartsWith("Under", StringComparison.OrdinalIgnoreCase))
        {
            return $"Under {name.Substring("Under".Length)}";
        }
        if (name.StartsWith("Above", StringComparison.OrdinalIgnoreCase))
        {
            return $"Above {name.Substring("Above".Length)}";
        }
        return name;
    }
}
