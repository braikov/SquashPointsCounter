@using System.Globalization
@model Squash.Web.Areas.Administration.Models.TournamentDayScheduleViewModel

@{
    ViewData["Title"] = Model.TournamentName;
    var culture = new CultureInfo("en-GB");
    var matchGroups = Model.Matches
        .GroupBy(m => string.IsNullOrWhiteSpace(m.Time) ? "-" : m.Time)
        .OrderBy(g => g.Key)
        .ToList();
    var hasFilters = !string.IsNullOrEmpty(Model.FilterEvent) || !string.IsNullOrEmpty(Model.FilterCountry) || !string.IsNullOrEmpty(Model.FilterDraw) || !string.IsNullOrEmpty(Model.FilterRound) || !string.IsNullOrEmpty(Model.FilterCourt);
}

<partial name="_TournamentTabs" model='new TournamentHeaderViewModel { Id = Model.TournamentId, Name = Model.TournamentName, ActiveTab = "DayMatches" }' />

<div class="row mb-4">
    <div class="col">
        <h1 class="h3 mb-1">Match schedule</h1>
        <div class="text-medium-emphasis">
            @(Model.SelectedDate.HasValue ? Model.SelectedDate.Value.ToString("dddd, dd MMMM yyyy", culture) : "No day selected")
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="tournament-days">
            @if (Model.Days.Count == 0)
            {
                <div class="text-medium-emphasis">No days available.</div>
            }
            else
            {
                foreach (var day in Model.Days)
                {
                    <a class="tournament-day @(day.IsSelected ? "is-active" : "")"
                       asp-area="Administration"
                       asp-controller="Tournaments"
                       asp-action="DayMatches"
                       asp-route-id="@Model.TournamentId"
                       asp-route-dayId="@day.Id">
                        <span class="tournament-day-week">@day.Date.ToString("ddd", culture)</span>
                        <span class="tournament-day-number">@day.Date.ToString("dd", culture)</span>
                        <span class="tournament-day-month">@day.Date.ToString("MMM", culture)</span>
                    </a>
                }
            }
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Filters</strong>
        <div class="d-flex gap-2">
            <select id="eventFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="">All Events</option>
                @foreach (var opt in Model.AvailableEvents)
                {
                    <option value="@opt.Value" selected="@(Model.FilterEvent == opt.Value)">@opt.Text</option>
                }
            </select>
            <select id="countryFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="">All Countries</option>
                @foreach (var opt in Model.AvailableCountries)
                {
                    <option value="@opt.Value" selected="@(Model.FilterCountry == opt.Value)">@opt.Text</option>
                }
            </select>
            <select id="drawFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="">All Draws</option>
                @foreach (var opt in Model.AvailableDraws)
                {
                    <option value="@opt.Value" selected="@(Model.FilterDraw == opt.Value)">@opt.Text</option>
                }
            </select>
            <select id="roundFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="">All Rounds</option>
                @foreach (var opt in Model.AvailableRounds)
                {
                    <option value="@opt.Value" selected="@(Model.FilterRound == opt.Value)">@opt.Text</option>
                }
            </select>
            <select id="courtFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="">All Courts</option>
                @foreach (var opt in Model.AvailableCourts)
                {
                    <option value="@opt.Value" selected="@(Model.FilterCourt == opt.Value)">@opt.Text</option>
                }
            </select>
            @if (hasFilters)
            {
                <a class="btn btn-sm btn-outline-secondary"
                   asp-area="Administration"
                   asp-controller="Tournaments"
                   asp-action="DayMatches"
                   asp-route-id="@Model.TournamentId"
                   asp-route-dayId="@Model.SelectedDayId">
                    Clear
                </a>
            }
        </div>
    </div>
    <div class="card-body py-2">
        <div class="text-muted">
            @if (hasFilters)
            {
                <span>Showing @Model.FilteredMatchesCount of @Model.TotalMatchesCount matches</span>
            }
            else
            {
                <span>Showing @Model.TotalMatchesCount matches</span>
            }
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        @if (Model.Matches.Count == 0)
        {
            <div class="text-medium-emphasis">No matches for this day.</div>
        }
        else
        {
            <div class="match-list">
                @foreach (var group in matchGroups)
                {
                    <div class="match-time-block">
                        <div class="match-time">@group.Key</div>
                        <div class="match-items">
                               @foreach (var match in group)
                               {
                                   var player1Walk = match.Player1Walkover || (match.Player2IsWinner && match.Games.Count == 0);
                                     var player2Walk = match.Player2Walkover || (match.Player1IsWinner && match.Games.Count == 0);
                                     var player1Wins = match.Player1IsWinner || player2Walk;
                                     var player2Wins = match.Player2IsWinner || player1Walk; 

                                <div class="match-card">
                                    <div class="match-card-info">
                                        <div class="match-card-header">
                                            <div class="match-card-title">@match.Draw</div>
                                            <div class="match-card-sub">@match.Round</div>
                                            @if (!string.IsNullOrWhiteSpace(match.Court))
                                            {
                                                <span class="match-pill match-pill-court">@match.Court</span>
                                            }
                                        </div>
                                        <div class="match-card-body">
                                            <div class="match-card-players">
                                                <div class="match-player-row">
                                                    <div class="match-player @(player1Wins ? "is-winner" : "")">
                                                        @if (player1Wins && !match.Player1Walkover)
                                                        {
                                                            <span class="winner-dot winner-dot-left"></span>
                                                        }
                                                        @if (match.Player1TournamentPlayerId.HasValue)
                                                        {
                                                            <a asp-controller="Tournaments" asp-action="TournamentPlayer" asp-route-id="@match.Player1TournamentPlayerId" class="player-row player-row-link" style="flex: 1; min-width: 0;">
                                                                @if (!string.IsNullOrWhiteSpace(match.Player1FlagUrl))
                                                                {
                                                                    <img class="player-flag" src="@match.Player1FlagUrl" alt="" />
                                                                }
                                                                <span class="player-name">@match.Player1</span>
                                                                
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            <div class="player-row" style="flex: 1; min-width: 0;">
                                                                @if (!string.IsNullOrWhiteSpace(match.Player1FlagUrl))
                                                                {
                                                                    <img class="player-flag" src="@match.Player1FlagUrl" alt="" />
                                                                }
                                                                <span class="player-name">@match.Player1</span>
                                                                
                                                            </div>
                                                        }
                                                        @if (match.Player1Walkover)
                                                        {
                                                            <span class="walkover-text">Walkover</span>
                                                        }
                                                    </div>
                                                    <div class="match-player-results">
                                                        @if (match.Player1Walkover)
                                                        {
                                                            <span class="walkover-text">Walkover</span>
                                                        }
                                                        else if (match.Games.Count > 0 && match.Games.Any(g => g.Side1Points.HasValue))
                                                        {
                                                            @foreach (var game in match.Games.Where(g => g.Side1Points.HasValue))
                                                            {
                                                                <div class="match-game-score @(game.WinnerSide == 1 ? "is-winner" : "")">
                                                                    @game.Side1Points
                                                                </div>
                                                            }
                                                        }
                                                        @if (player1Wins && !match.Player1Walkover)
                                                        {
                                                            <span class="winner-dot winner-dot-results"></span>
                                                        }
                                                    </div>
                                                </div>
                                                <span class="match-player-separator">-</span>
                                                <div class="match-player-row">
                                                    <div class="match-player @(player2Wins ? "is-winner" : "")">
                                                        @if (player2Wins && !match.Player2Walkover)
                                                        {
                                                            <span class="winner-dot winner-dot-left"></span>
                                                        }
                                                        @if (match.Player2TournamentPlayerId.HasValue)
                                                        {
                                                            <a asp-controller="Tournaments" asp-action="TournamentPlayer" asp-route-id="@match.Player2TournamentPlayerId" class="player-row player-row-link" style="flex: 1; min-width: 0;">
                                                                @if (!string.IsNullOrWhiteSpace(match.Player2FlagUrl))
                                                                {
                                                                    <img class="player-flag" src="@match.Player2FlagUrl" alt="" />
                                                                }
                                                                <span class="player-name">@match.Player2</span>
                                                                
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            <div class="player-row" style="flex: 1; min-width: 0;">
                                                                @if (!string.IsNullOrWhiteSpace(match.Player2FlagUrl))
                                                                {
                                                                    <img class="player-flag" src="@match.Player2FlagUrl" alt="" />
                                                                }
                                                                <span class="player-name">@match.Player2</span>
                                                                
                                                            </div>
                                                        }
                                                        @if (match.Player2Walkover)
                                                        {
                                                            <span class="walkover-text">Walkover</span>
                                                        }
                                                        @if (player2Wins && !match.Player2Walkover)
                                                        {
                                                            <span class="winner-dot winner-dot-right"></span>
                                                        }
                                                    </div>
                                                    <div class="match-player-results">
                                                        @if (match.Player2Walkover)
                                                        {
                                                            <span class="walkover-text">Walkover</span>
                                                        }
                                                        else if (match.Games.Count > 0 && match.Games.Any(g => g.Side2Points.HasValue))
                                                        {
                                                            @foreach (var game in match.Games.Where(g => g.Side2Points.HasValue))
                                                            {
                                                                <div class="match-game-score @(game.WinnerSide == 2 ? "is-winner" : "")">
                                                                    @game.Side2Points
                                                                </div>
                                                            }
                                                        }
                                                        @if (player2Wins && !match.Player2Walkover)
                                                        {
                                                            <span class="winner-dot winner-dot-results"></span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            @if (!match.IsFinished && !string.IsNullOrWhiteSpace(match.PinCode))
                                            {
                                                <div class="match-card-pin">@match.PinCode.ToUpperInvariant()</div>
                                            }
                                        </div>
                                    </div>
                                    <div class="match-card-meta">
                                        @if (!string.IsNullOrWhiteSpace(match.Court))
                                        {
                                            <span class="match-pill match-pill-court-desktop">@match.Court</span>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(match.Status))
                                        {
                                            <span class="match-pill match-pill-muted">@match.Status</span>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(match.PinCode) && !(match.IsFinished && match.Games.Count > 0))
                                        {
                                            <a class="match-pill match-pill-action match-pill-kiosk" href="/m?pin=@match.PinCode" target="_blank" rel="noopener">Open in kiosk</a>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var eventFilter = document.getElementById('eventFilter');
            var countryFilter = document.getElementById('countryFilter');
            var drawFilter = document.getElementById('drawFilter');
            var roundFilter = document.getElementById('roundFilter');
            var courtFilter = document.getElementById('courtFilter');

            // Set current filter values
            eventFilter.value = '@Model.FilterEvent';
            countryFilter.value = '@Model.FilterCountry';
            drawFilter.value = '@Model.FilterDraw';
            roundFilter.value = '@Model.FilterRound';
            courtFilter.value = '@Model.FilterCourt';

            function applyFilters() {
                var url = new URL(window.location.href);
                
                if (eventFilter.value) {
                    url.searchParams.set('eventName', eventFilter.value);
                } else {
                    url.searchParams.delete('eventName');
                }

                if (countryFilter.value) {
                    url.searchParams.set('country', countryFilter.value);
                } else {
                    url.searchParams.delete('country');
                }

                if (drawFilter.value) {
                    url.searchParams.set('draw', drawFilter.value);
                } else {
                    url.searchParams.delete('draw');
                }

                if (roundFilter.value) {
                    url.searchParams.set('round', roundFilter.value);
                } else {
                    url.searchParams.delete('round');
                }

                if (courtFilter.value) {
                    url.searchParams.set('court', courtFilter.value);
                } else {
                    url.searchParams.delete('court');
                }

                window.location.href = url.toString();
            }

            eventFilter.addEventListener('change', applyFilters);
            countryFilter.addEventListener('change', applyFilters);
            drawFilter.addEventListener('change', applyFilters);
            roundFilter.addEventListener('change', applyFilters);
            courtFilter.addEventListener('change', applyFilters);
        });
    </script>
}
