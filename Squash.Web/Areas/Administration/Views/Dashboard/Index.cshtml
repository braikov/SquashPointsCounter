@model Squash.Web.Areas.Administration.Models.DashboardViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h3 class="mb-1">Dashboard</h3>
            <small class="text-muted">System overview & key metrics</small>
        </div>
        <div class="col-auto">
            <a asp-area="Administration" asp-controller="Users" asp-action="Index" class="btn btn-sm btn-primary me-2">
                <svg class="icon me-1"><use xlink:href="/images/icons.svg#cil-user"></use></svg> Users
            </a>
            <a asp-area="Administration" asp-controller="Tournaments" asp-action="Index" class="btn btn-sm btn-success me-2">
                <svg class="icon me-1"><use xlink:href="/images/icons.svg#cil-flag-alt"></use></svg> Tournaments
            </a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-6">
            <div class="card border-start border-primary border-3 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary bg-opacity-10 rounded p-3">
                                <svg class="icon icon-xl text-primary"><use xlink:href="/images/icons.svg#cil-user"></use></svg>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-muted small text-uppercase">Total Users</div>
                            <div class="fs-4 fw-bold">@Model.TotalUsers.ToString("N0")</div>
                            <div class="small">
                                <span class="text-success">+@Model.NewUsersLast30Days</span>
                                <span class="text-muted">last 30 days</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card border-start border-success border-3 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-success bg-opacity-10 rounded p-3">
                                <svg class="icon icon-xl text-success"><use xlink:href="/images/icons.svg#cil-flag-alt"></use></svg>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-muted small text-uppercase">Total Tournaments</div>
                            <div class="fs-4 fw-bold">@Model.TotalTournaments.ToString("N0")</div>
                            <div class="small">
                                <span class="text-success">+@Model.NewTournamentsLast30Days</span>
                                <span class="text-muted">last 30 days</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-header bg-primary bg-opacity-10">
                    <strong>User Signups (Last 30 Days)</strong>
                </div>
                <div class="card-body">
                    <canvas id="userSignupsChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-header bg-success bg-opacity-10">
                    <strong>Tournament Creations (Last 30 Days)</strong>
                </div>
                <div class="card-body">
                    <canvas id="tournamentCreationsChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/chart.js/dist/chart.umd.min.js" asp-append-version="true"></script>
    <script>
        (function () {
            var userSignupsByDay = @Html.Raw(JsonSerializer.Serialize(Model.UserSignupsByDay));
            var tournamentsByDay = @Html.Raw(JsonSerializer.Serialize(Model.TournamentCreationsByDay));

            function labelsAndValues(dict) {
                var labels = [], values = [];
                Object.keys(dict || {}).forEach(function (k) {
                    labels.push(k);
                    values.push(dict[k]);
                });
                return { labels: labels, values: values };
            }

            var signups = labelsAndValues(userSignupsByDay);
            new Chart(document.getElementById('userSignupsChart'), {
                type: 'line',
                data: {
                    labels: signups.labels,
                    datasets: [{
                        label: 'Users',
                        data: signups.values,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });

            var tournaments = labelsAndValues(tournamentsByDay);
            new Chart(document.getElementById('tournamentCreationsChart'), {
                type: 'line',
                data: {
                    labels: tournaments.labels,
                    datasets: [{
                        label: 'Tournaments',
                        data: tournaments.values,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        })();
    </script>
}
